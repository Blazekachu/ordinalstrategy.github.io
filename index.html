// === Live Bitcoin Data from mempool.space ===
const blockElem = document.getElementById('block-height');
const mempoolElem = document.getElementById('mempool-count');
const avgFeeElem = document.getElementById('avg-fee');

// Fetch once using REST
async function fetchSnapshot() {
  try {
    const [blocksResp, mempoolResp] = await Promise.all([
      fetch('https://mempool.space/api/blocks'),
      fetch('https://mempool.space/api/mempool')
    ]);

    const blocks = await blocksResp.json();
    const mempool = await mempoolResp.json();

    if (blocks && blocks[0]) blockElem.textContent = blocks[0].height;
    if (mempool && mempool.count) mempoolElem.textContent = mempool.count.toLocaleString();
    if (mempool && mempool.vbytes_per_fee) {
      avgFeeElem.textContent = Math.round(mempool.vbytes_per_fee['1'] || 0);
    }
  } catch (err) {
    console.error('REST fetch error:', err);
  }
}

// Connect WebSocket
function connectWS() {
  const ws = new WebSocket('wss://mempool.space/api/v1/ws');

  ws.onopen = () => {
    console.log('Mempool WS connected');
    ws.send(JSON.stringify({ action: "want", data: ["blocks", "mempool-blocks"] }));
  };

  ws.onmessage = (msg) => {
    try {
      const data = JSON.parse(msg.data);

      if (data.block) {
        blockElem.textContent = data.block.height;
      }

      if (data.mempoolInfo) {
        mempoolElem.textContent = data.mempoolInfo.count.toLocaleString();
        avgFeeElem.textContent = Math.round(data.mempoolInfo.vbytes_per_fee['1'] || 0);
      }

    } catch (e) {
      console.warn('WS parse issue:', e);
    }
  };

  ws.onclose = () => {
    console.log('Mempool WS closed â€” reconnecting in 5s');
    setTimeout(connectWS, 5000);
  };
}

// Initialize
fetchSnapshot();
connectWS();
setInterval(fetchSnapshot, 60000); // backup refresh every 60s
